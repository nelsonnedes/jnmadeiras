<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JN Madeiras - √Årea Administrativa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #2c1810;
            color: white;
            border-radius: 8px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .menu {
            position: absolute;
            right: 20px;
            top: 20px;
        }

        .menu-button {
            background-color: #4a3228;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 10px;
            text-decoration: none;
        }

        .menu-button:hover {
            background-color: #5f422f;
        }

        .promo-section {
            background: linear-gradient(135deg, #2c1810 0%, #4a3228 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: white;
        }

        .promo-section textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 1em;
            resize: vertical;
        }

        .promo-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #fff;
        }

        .wood-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-collapse: collapse;
            margin-bottom: 20px;
            overflow-x: auto;
            display: block;
        }

        .wood-table th,
        .wood-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            min-width: 120px;
        }

        .wood-table th {
            background-color: #4a3228;
            color: white;
            white-space: nowrap;
        }

        .wood-table tr:hover {
            background-color: #f9f9f9;
        }

        .wood-table input[type="text"],
        .wood-table input[type="number"] {
            width: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .wood-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .wood-table input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .action-button {
            padding: 15px 30px;
            background-color: #2c1810;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s;
        }

        .action-button:hover {
            background-color: #4a3228;
        }

        .delete-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background-color: #2c1810;
            color: white;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .menu-icon {
            font-size: 24px;
            cursor: pointer;
            color: white;
            background: none;
            border: none;
            padding: 10px;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            min-width: 18px;
            text-align: center;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: #2c1810;
            padding: 20px;
            transition: left 0.3s ease;
            z-index: 1000;
            color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.5em;
            color: white;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-content a {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .sidebar-content a:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .sidebar-content a i {
            width: 20px;
            text-align: center;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            transition: opacity 0.3s;
        }

        .overlay.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            cursor: move;
            padding: 10px;
            background-color: #2c1810;
            color: white;
            border-radius: 12px 12px 0 0;
            margin: -30px -30px 20px -30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .modal-header h2 {
            margin: 0;
            padding: 0 20px;
            border: none;
            color: white !important;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            justify-content: center;
        }

        .modal-header h2 i {
            color: #4a3228;
        }

        .modal-header .close-modal {
            color: white;
            padding: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            position: absolute;
            right: 10px;
        }

        .modal-content h2 {
            color: #2c1810;
            text-align: center;
            margin-bottom: 25px;
            font-size: 24px;
            border-bottom: 2px solid #2c1810;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-content h2 i {
            color: #4a3228;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c1810;
            font-weight: bold;
            font-size: 0.95em;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            border-color: #2c1810;
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 24, 16, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .submit-button, .cancel-button {
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .submit-button {
            background-color: #2c1810;
            color: white;
            border: none;
        }

        .submit-button:hover {
            background-color: #4a3228;
            transform: translateY(-2px);
        }

        .cancel-button {
            background-color: #6c757d;
            color: white;
            border: none;
        }

        .cancel-button:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .password-requirements {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9em;
            color: #666;
        }

        .password-requirements h4 {
            color: #2c1810;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .password-requirements ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .password-requirements li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .password-requirements li i {
            color: #2c1810;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
        }

        .company-settings {
            padding: 20px;
            max-height: calc(90vh - 150px);
            overflow-y: auto;
            margin: -20px;
            padding-right: 40px;
        }

        .company-settings::-webkit-scrollbar {
            width: 8px;
        }

        .company-settings::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .company-settings::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .company-settings::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .company-settings .form-group {
            margin-bottom: 20px;
        }

        .company-settings label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .company-settings input,
        .company-settings textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .company-logo-preview {
            max-width: 200px;
            margin: 10px 0;
        }

        .quote-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .quote-list th,
        .quote-list td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .quote-list th {
            background-color: #4a3228;
            color: white;
        }

        .quote-list tr:hover {
            background-color: #f5f5f5;
        }

        .action-buttons button {
            padding: 5px 10px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .view-button {
            background-color: #2c1810;
            color: white;
        }

        .respond-button {
            background-color: #28a745;
            color: white;
        }

        .edit-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .edit-button:hover {
            background-color: #218838;
        }

        #editQuoteForm {
            overflow-y: auto;
            max-height: calc(90vh - 100px);
            padding-right: 10px;
        }

        #editQuoteForm::-webkit-scrollbar {
            width: 8px;
        }

        #editQuoteForm::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #editQuoteForm::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #editQuoteForm::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .pdf-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .pdf-button:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        #companySettingsForm {
            overflow-y: auto;
            max-height: calc(90vh - 150px);
            padding-right: 10px;
        }

        #companySettingsForm::-webkit-scrollbar {
            width: 8px;
        }

        #companySettingsForm::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #companySettingsForm::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #companySettingsForm::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .notification-icon {
            position: relative;
            margin-left: 20px;
        }

        .notification-link {
            font-size: 24px;
            text-decoration: none;
            color: white;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ff4444;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            min-width: 18px;
            text-align: center;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-button, .admin-button {
            background-color: #4a3228;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .back-button:hover, .admin-button:hover {
            background-color: #5f422f;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .header-right {
                width: 100%;
                justify-content: center;
            }

            .admin-button {
                width: 100%;
                text-align: center;
            }

            .products-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .product-card {
                margin: 0;
            }

            .product-card img {
                height: 150px;
            }

            .product-info {
                padding: 10px;
            }

            .product-info h3 {
                font-size: 1.1em;
            }

            .product-info p {
                font-size: 0.9em;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
                margin: 10px;
            }

            .modal-header {
                flex-direction: column;
                gap: 10px;
            }

            .modal-header h2 {
                font-size: 1.2em;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group input,
            .form-group textarea {
                font-size: 16px;
                padding: 12px;
            }

            .action-button {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }

            .product-form {
                padding: 15px;
            }

            .product-form input,
            .product-form textarea {
                font-size: 16px;
                padding: 12px;
            }

            .product-form button {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }
        }

        /* Ajustes para telas muito pequenas */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2em;
            }

            .product-card img {
                height: 120px;
            }

            .product-info h3 {
                font-size: 1em;
            }

            .product-info p {
                font-size: 0.8em;
            }

            .modal-content {
                padding: 10px;
            }

            .form-group input,
            .form-group textarea,
            .product-form input,
            .product-form textarea {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gerenciar Produtos</h1>
            <div class="header-buttons">
                <a href="index.html" class="back-button">Voltar para a P√°gina Inicial</a>
                <div class="header-right">
                    <a href="admin.html" class="admin-button">√Årea Administrativa</a>
                    <div class="notification-icon">
                        <a href="orcamentos.html" class="notification-link">
                            üîî
                            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="promo-section">
            <label for="promoText">Ofertas e Promo√ß√µes:</label>
            <textarea id="promoText" placeholder="Digite aqui as ofertas e promo√ß√µes especiais..." onchange="updatePromoText(this.value)"></textarea>
        </div>

        <table class="wood-table">
            <thead>
                <tr>
                    <th>Esp√©cie</th>
                    <th>Quantidade em Tora (m¬≥)</th>
                    <th>Rendimento (%)</th>
                    <th>Quantidade Serrada (m¬≥)</th>
                    <th>Pre√ßo (R$)</th>
                    <th>Exibir</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="woodTableBody">
            </tbody>
        </table>

        <div class="button-container">
            <button class="action-button" onclick="adicionarItem()">Adicionar Novo Item</button>
            <button class="action-button" onclick="salvarAlteracoes()">Salvar Altera√ß√µes</button>
        </div>

        <div id="status" class="status"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Menu</h3>
            <button class="close-sidebar" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <a href="#" onclick="showCompanySettings()">
                <i class="fas fa-building"></i> Configura√ß√µes da Empresa
            </a>
            <a href="orcamento.html" onclick="showQuotes()"> 
                <i class="fas fa-file-invoice-dollar"></i> Or√ßamentos
            </a>
            <a href="#" onclick="showChangePassword()">
                <i class="fas fa-key"></i> Alterar Senha
            </a>
            <a href="index.html">
                <i class="fas fa-home"></i> Voltar para Home
            </a>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Modal de Configura√ß√µes da Empresa -->
    <div class="modal" id="companySettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-building"></i> Configura√ß√µes da Empresa</h2>
                <button class="close-modal" onclick="closeModal('companySettingsModal')">&times;</button>
            </div>
            <form id="companySettingsForm" onsubmit="saveCompanySettings(event)">
                <div class="form-group">
                    <label for="companyLogo">Logo da Empresa:</label>
                    <input type="file" id="companyLogo" accept="image/*" onchange="previewLogo(event)">
                    <img id="logoPreview" class="company-logo-preview" style="display: none;">
                </div>
                <div class="form-group">
                    <label for="companyName">Nome da Empresa:</label>
                    <input type="text" id="companyName" required>
                </div>
                <div class="form-group">
                    <label for="companyAddress">Endere√ßo:</label>
                    <textarea id="companyAddress" required></textarea>
                </div>
                <div class="form-group">
                    <label for="companyPhone">Telefone:</label>
                    <input type="tel" id="companyPhone" required>
                </div>
                <div class="form-group">
                    <label for="companyEmail">E-mail:</label>
                    <input type="email" id="companyEmail" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="submit-button">
                        <i class="fas fa-save"></i> Salvar Configura√ß√µes
                    </button>
                    <button type="button" class="cancel-button" onclick="closeModal('companySettingsModal')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Or√ßamentos -->
    <div class="modal" id="quotesModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('quotesModal')">&times;</button>
            <h2>Or√ßamentos Recebidos</h2>
            <table class="quote-list">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Cidade/Estado</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="quotesList">
                    <!-- Preenchido via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal de Visualiza√ß√£o/Resposta de Or√ßamento -->
    <div class="modal" id="quoteDetailModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('quoteDetailModal')">&times;</button>
            <h2>Detalhes do Or√ßamento</h2>
            <div id="quoteDetail">
                <!-- Preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal de Alterar Senha -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-key"></i> Alterar Senha</h2>
            <div class="form-group">
                <label for="currentPassword">Senha Atual:</label>
                <input type="password" id="currentPassword" required placeholder="Digite sua senha atual">
            </div>
            <div class="form-group">
                <label for="newPassword">Nova Senha:</label>
                <input type="password" id="newPassword" required placeholder="Digite a nova senha">
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirmar Nova Senha:</label>
                <input type="password" id="confirmPassword" required placeholder="Confirme a nova senha">
            </div>
            <div class="password-requirements">
                <h4>Requisitos da Senha:</h4>
                <ul>
                    <li><i class="fas fa-check-circle"></i> M√≠nimo de 8 caracteres</li>
                    <li><i class="fas fa-check-circle"></i> Deve conter letras e n√∫meros</li>
                    <li><i class="fas fa-check-circle"></i> Evite usar caracteres especiais</li>
                </ul>
            </div>
            <div class="modal-buttons">
                <button onclick="changePassword()" class="submit-button">
                    <i class="fas fa-save"></i> Salvar
                </button>
                <button onclick="closeChangePasswordModal()" class="cancel-button">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Or√ßamento -->
    <div class="modal" id="editQuoteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Editar Or√ßamento</h2>
                <button class="close-modal" onclick="closeModal('editQuoteModal')">&times;</button>
            </div>
            <form id="editQuoteForm" onsubmit="saveChanges(event)">
                <div class="form-group">
                    <label for="editNome">Nome do Cliente:</label>
                    <input type="text" id="editNome" required>
                </div>
                <div class="form-group">
                    <label for="editTelefone">Telefone:</label>
                    <input type="tel" id="editTelefone" required>
                </div>
                <div class="form-group">
                    <label for="editEstado">Estado:</label>
                    <input type="text" id="editEstado" required maxlength="2">
                </div>
                <div class="form-group">
                    <label for="editCidade">Cidade:</label>
                    <input type="text" id="editCidade" required>
                </div>
                <div class="form-group">
                    <label>Esp√©cies de Madeira:</label>
                    <div id="editEspecies" class="species-grid">
                        <!-- As esp√©cies ser√£o carregadas aqui via JavaScript -->
                    </div>
                    <input type="hidden" id="editSelectedSpecies" name="editSelectedSpecies">
                </div>
                <div class="form-group">
                    <label for="editPedido">Detalhes do Pedido:</label>
                    <textarea id="editPedido" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editObservacoes">Observa√ß√µes:</label>
                    <textarea id="editObservacoes"></textarea>
                </div>
                <div class="form-group">
                    <label for="editContraProposta">Contra Proposta:</label>
                    <textarea id="editContraProposta" placeholder="Digite aqui sua contra proposta..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="submit-button">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <button type="button" class="pdf-button" onclick="generateAndSendPDF(event)">
                        <i class="fas fa-file-pdf"></i> Gerar PDF e Enviar
                    </button>
                    <button type="button" class="cancel-button" onclick="closeModal('editQuoteModal')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Verificar autentica√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            if (!isAdmin) {
                window.location.href = 'index.html';
                return;
            }
        });

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBd1MS-izKfE6Y6QTH_3-giQzZz6FraBkI",
            authDomain: "comercial-5bc01.firebaseapp.com",
            projectId: "comercial-5bc01",
            storageBucket: "comercial-5bc01.firebasestorage.app",
            messagingSenderId: "956944566020",
            appId: "1:956944566020:web:dc3e58cba5afcc6e9b7251",
            measurementId: "G-RF6Y1FZBM9",
            databaseURL: "https://comercial-5bc01-default-rtdb.firebaseio.com"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const woodRef = database.ref('woodData');
        const promoRef = database.ref('promoText');
        const quotesRef = database.ref('quotes');

        let woodData = [];
        let promoText = '';
        let currentEditingQuoteIndex = -1;

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + (isError ? 'error' : 'success');
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatVolume(value) {
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 3,
                maximumFractionDigits: 3
            }).format(value) + ' m¬≥';
        }

        function unformatNumber(value) {
            console.log('Valor original:', value);
            // Remover qualquer caractere que n√£o seja d√≠gito, v√≠rgula, ponto ou sinal
            const cleanValue = value.replace(/[^\d,.+-]/g, '');
            console.log('Ap√≥s remover caracteres inv√°lidos:', cleanValue);
            
            // Substituir v√≠rgula por ponto para convers√£o correta para n√∫mero
            const normalizedValue = cleanValue.replace(/,/g, '.');
            console.log('Ap√≥s normalizar separador decimal:', normalizedValue);
            
            // Converter para n√∫mero
            const numericValue = parseFloat(normalizedValue);
            console.log('Valor num√©rico final:', numericValue);
            
            return numericValue;
        }

        function loadWoodData() {
            woodRef.on('value', (snapshot) => {
                woodData = snapshot.val() || [];
                renderTable();
                
                // Verificar especificamente a Ma√ßaranduba
                checkMacaranduba();
            });
        }
        
        function checkMacaranduba() {
            console.log('Verificando dados da Ma√ßaranduba:');
            const macaranduba = woodData.find(wood => wood.name === 'Ma√ßaranduba');
            
            if (macaranduba) {
                console.log('Ma√ßaranduba encontrada no √≠ndice:', woodData.indexOf(macaranduba));
                console.log('Dados completos:', macaranduba);
                console.log('Tipo do pre√ßo:', typeof macaranduba.price);
                console.log('Valor do pre√ßo:', macaranduba.price);
            } else {
                console.log('Ma√ßaranduba n√£o encontrada na lista de produtos');
            }
        }

        function loadPromoText() {
            promoRef.on('value', (snapshot) => {
                const promoText = snapshot.val() || '';
                document.getElementById('promoText').value = promoText;
            });
        }

        function renderTable() {
            const tbody = document.getElementById('woodTableBody');
            tbody.innerHTML = '';

            // Criar um mapeamento de √≠ndices ordenados para √≠ndices originais
            const originalIndices = woodData.map((_, index) => index);
            
            // Ordenar os produtos em ordem alfab√©tica por nome, mas manter refer√™ncia ao √≠ndice original
            const sortedData = woodData.map((wood, index) => ({ 
                wood, 
                originalIndex: index 
            })).sort((a, b) => 
                a.wood.name.localeCompare(b.wood.name, 'pt-BR')
            );

            // Renderizar a tabela usando os √≠ndices originais para as opera√ß√µes de atualiza√ß√£o
            sortedData.forEach(({ wood, originalIndex }) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="text" 
                               value="${wood.name || ''}"
                               onchange="updateName(${originalIndex}, this.value)">
                    </td>
                    <td>
                        <input type="text" 
                               value="${formatVolume(wood.quantidadeTora || 0)}"
                               onchange="updateTora(${originalIndex}, this.value)">
                    </td>
                    <td>
                        <input type="number" 
                               min="0" 
                               max="100" 
                               value="${wood.porcentagem || 0}" 
                               onchange="updatePorcentagem(${originalIndex}, this.value)">
                    </td>
                    <td>
                        <input type="text" 
                               value="${formatVolume(wood.quantidadeSerrada || 0)}"
                               readonly>
                    </td>
                    <td>
                        <input type="text" 
                               value="${formatCurrency(wood.price || 0)}"
                               onchange="updatePrice(${originalIndex}, this.value)">
                    </td>
                    <td>
                        <input type="checkbox" 
                               ${wood.visible ? 'checked' : ''} 
                               onchange="updateVisibility(${originalIndex}, this.checked)">
                    </td>
                    <td>
                        <button class="delete-button" onclick="excluirItem(${originalIndex})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function calculateSerrada(tora, porcentagem) {
            return (tora * porcentagem) / 100;
        }

        function updateName(index, value) {
            woodData[index].name = value;
            woodRef.set(woodData);
        }

        function updateTora(index, value) {
            const quantidade = unformatNumber(value);
            woodData[index].quantidadeTora = quantidade;
            woodData[index].quantidadeSerrada = calculateSerrada(
                woodData[index].quantidadeTora,
                woodData[index].porcentagem
            );
            woodRef.set(woodData);
        }

        function updatePorcentagem(index, value) {
            woodData[index].porcentagem = parseFloat(value);
            woodData[index].quantidadeSerrada = calculateSerrada(
                woodData[index].quantidadeTora,
                woodData[index].porcentagem
            );
            woodRef.set(woodData);
        }

        function updatePrice(index, value) {
            console.log('Atualizando pre√ßo para o produto de √≠ndice', index);
            console.log('Nome do produto:', woodData[index].name);
            console.log('Pre√ßo anterior:', woodData[index].price);
            
            const newPrice = unformatNumber(value);
            console.log('Novo pre√ßo calculado:', newPrice);
            
            if (isNaN(newPrice)) {
                console.error('Erro: o valor convertido √© NaN');
                showStatus('Erro ao atualizar o pre√ßo. Formato inv√°lido.', true);
                return;
            }
            
            woodData[index].price = newPrice;
            console.log('Pre√ßo atualizado no objeto woodData:', woodData[index].price);
            
            // Salvar no Firebase
            woodRef.set(woodData)
                .then(() => {
                    console.log('Pre√ßo salvo com sucesso no Firebase');
                    showStatus('Pre√ßo atualizado com sucesso!');
                })
                .catch(error => {
                    console.error('Erro ao salvar no Firebase:', error);
                    showStatus('Erro ao salvar no Firebase: ' + error.message, true);
                });
        }

        function updateVisibility(index, visible) {
            woodData[index].visible = visible;
            woodRef.set(woodData);
        }

        function excluirItem(index) {
            if (confirm('Tem certeza que deseja excluir este item?')) {
                woodData.splice(index, 1);
                woodRef.set(woodData);
                showStatus('Item exclu√≠do com sucesso!');
            }
        }

        function adicionarItem() {
            const novoItem = {
                name: "Nova Esp√©cie",
                price: 0,
                visible: true,
                quantidadeTora: 0,
                porcentagem: 50,
                quantidadeSerrada: 0
            };
            woodData.push(novoItem);
            woodRef.set(woodData);
            showStatus('Novo item adicionado com sucesso!');
        }

        function updatePromoText(value) {
            promoRef.set(value);
        }

        function salvarAlteracoes() {
            woodRef.set(woodData);
            showStatus('Altera√ß√µes salvas com sucesso!');
        }

        // Fun√ß√µes do Menu Lateral
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Fun√ß√µes dos Modais
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            
            // Resetar a posi√ß√£o do modal
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.transform = 'translate3d(0px, 0px, 0)';
            
            // Tornar o modal arrast√°vel se for o modal de edi√ß√£o
            if (modalId === 'editQuoteModal') {
                makeDraggable(modalId);
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
            
            // Resetar a posi√ß√£o do modal
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.transform = 'translate3d(0px, 0px, 0)';
        }

        function showCompanySettings() {
            toggleSidebar();
            showModal('companySettingsModal');
            loadCompanySettings();
        }

        function showQuotes() {
            showModal('quotesModal');
            loadQuotes();
            // Resetar contador de notifica√ß√µes
            localStorage.setItem('notificacoes', '0');
            updateNotificationCount();
        }

        // Fun√ß√µes de Configura√ß√µes da Empresa
        function previewLogo(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('logoPreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    localStorage.setItem('companyLogo', e.target.result);
                }
                reader.readAsDataURL(file);
            }
        }

        function saveCompanySettings(event) {
            event.preventDefault();
            
            const settings = {
                name: document.getElementById('companyName').value,
                address: document.getElementById('companyAddress').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                logo: document.getElementById('logoPreview').src
            };
            
            localStorage.setItem('companySettings', JSON.stringify(settings));
            alert('Configura√ß√µes salvas com sucesso!');
            closeModal('companySettingsModal');
        }

        function loadCompanySettings() {
            const settings = JSON.parse(localStorage.getItem('companySettings') || '{}');
            
            if (settings.logo) {
                document.getElementById('logoPreview').src = settings.logo;
                document.getElementById('logoPreview').style.display = 'block';
            }
            
            document.getElementById('companyName').value = settings.name || '';
            document.getElementById('companyAddress').value = settings.address || '';
            document.getElementById('companyPhone').value = settings.phone || '';
            document.getElementById('companyEmail').value = settings.email || '';
        }

        // Fun√ß√µes de Or√ßamentos
        function loadQuotes() {
            // Carregar or√ßamentos do Firebase em vez do localStorage
            quotesRef.on('value', (snapshot) => {
                const quotes = snapshot.val() || {};
                const tbody = document.getElementById('quotesList');
                tbody.innerHTML = '';
                
                // Converter objeto de or√ßamentos em array
                const quotesArray = Object.entries(quotes).map(([id, quote]) => ({
                    id,
                    ...quote
                }));
                
                // Ordenar por data (mais recentes primeiro)
                quotesArray.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                if (quotesArray.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum or√ßamento encontrado</td></tr>';
                    return;
                }
                
                quotesArray.forEach((quote) => {
                    const tr = document.createElement('tr');
                    const date = new Date(quote.data).toLocaleDateString('pt-BR');
                    
                    tr.innerHTML = `
                        <td>${date}</td>
                        <td>${quote.nome || 'N/A'}</td>
                        <td>${quote.cidade || 'N/A'}/${quote.estado || 'N/A'}</td>
                        <td>${quote.status || 'pendente'}</td>
                        <td class="action-buttons">
                            <button class="view-button" onclick="viewQuote('${quote.id}')">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="edit-button" onclick="editQuote('${quote.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
            }, (error) => {
                console.error('Erro ao carregar or√ßamentos:', error);
                showStatus('Erro ao carregar or√ßamentos. Tente novamente.', true);
            });
        }

        function viewQuote(quoteId) {
            // Buscar or√ßamento do Firebase
            quotesRef.child(quoteId).once('value').then((snapshot) => {
                const quote = snapshot.val();
                if (!quote) {
                    showStatus('Or√ßamento n√£o encontrado', true);
                    return;
                }
                
                const detail = document.getElementById('quoteDetail');
                
                // Construir a lista de produtos
                let produtosHTML = '';
                if (quote.produtos && quote.produtos.length > 0) {
                    produtosHTML = quote.produtos.map(p => 
                        `<span style="display: inline-block; background: #f0f0f0; padding: 5px 10px; margin: 5px; border-radius: 4px;">
                            ${p.nome} - ${p.quantidade} m¬≥
                        </span>`
                    ).join('');
                } else if (quote.especies && quote.especies.length > 0) {
                    // Compatibilidade com o formato antigo
                    produtosHTML = quote.especies.map(especie => 
                        `<span style="display: inline-block; background: #f0f0f0; padding: 5px 10px; margin: 5px; border-radius: 4px;">
                            ${especie}
                        </span>`
                    ).join('');
                }
                
                detail.innerHTML = `
                    <div style="padding: 20px;">
                        <h3>Informa√ß√µes do Cliente</h3>
                        <p><strong>Nome:</strong> ${quote.nome || 'N/A'}</p>
                        <p><strong>Telefone:</strong> ${quote.telefone || 'N/A'}</p>
                        <p><strong>Localiza√ß√£o:</strong> ${quote.cidade || 'N/A'}/${quote.estado || 'N/A'}</p>
                        
                        <h3>Produtos de Interesse</h3>
                        <div style="margin: 10px 0;">
                            ${produtosHTML || 'Nenhum produto selecionado'}
                        </div>
                        
                        <h3>Detalhes do Pedido</h3>
                        <p><strong>Pedido:</strong></p>
                        <pre style="white-space: pre-wrap;">${quote.pedido || 'Sem detalhes'}</pre>
                        
                        <h3>Observa√ß√µes</h3>
                        <pre style="white-space: pre-wrap;">${quote.observacoes || 'Nenhuma observa√ß√£o'}</pre>
                    </div>
                `;
                
                showModal('quoteDetailModal');
            }).catch(error => {
                console.error('Erro ao buscar or√ßamento:', error);
                showStatus('Erro ao buscar detalhes do or√ßamento', true);
            });
        }

        function editQuote(quoteId) {
            // Buscar or√ßamento do Firebase
            quotesRef.child(quoteId).once('value').then((snapshot) => {
                const quote = snapshot.val();
                if (!quote) {
                    showStatus('Or√ßamento n√£o encontrado', true);
                    return;
                }
                
                // Preencher o formul√°rio com os dados do or√ßamento
                document.getElementById('editNome').value = quote.nome || '';
                document.getElementById('editTelefone').value = quote.telefone || '';
                document.getElementById('editEstado').value = quote.estado || '';
                document.getElementById('editCidade').value = quote.cidade || '';
                document.getElementById('editPedido').value = quote.pedido || '';
                document.getElementById('editObservacoes').value = quote.observacoes || '';
                document.getElementById('editContraProposta').value = quote.contraProposta || '';

                // Preencher as esp√©cies
                const especiesDiv = document.getElementById('editEspecies');
                especiesDiv.innerHTML = '';
                
                // Criar um mapa para os produtos
                let produtosMap = new Map();
                
                // Verificar se temos produtos no formato novo (com nome e quantidade)
                if (quote.produtos && quote.produtos.length > 0) {
                    produtosMap = new Map(
                        quote.produtos.map(p => [p.nome, p.quantidade])
                    );
                } 
                // Compatibilidade com formato antigo (especies como string)
                else if (quote.especies && quote.especies.length > 0) {
                    produtosMap = new Map(
                        quote.especies.map(species => {
                            const [name, price] = species.split(' - ');
                            return [name, price];
                        })
                    );
                }
                
                // Atualizar o form com os produtos selecionados e buscar pre√ßos atualizados no woodData
                if (woodData && woodData.length > 0) {
                    // Ordenar por nome
                    const sortedWoodData = [...woodData].sort((a, b) => 
                        a.name.localeCompare(b.name, 'pt-BR')
                    );
                    
                    sortedWoodData.forEach(wood => {
                        if (wood.visible) {
                            const isSelected = produtosMap.has(wood.name);
                            const div = document.createElement('div');
                            div.className = 'species-item';
                            
                            // Determinar o pre√ßo/quantidade a mostrar
                            const valorProduto = isSelected 
                                ? produtosMap.get(wood.name) 
                                : formatCurrency(wood.price);
                            
                            div.innerHTML = `
                                <input type="checkbox" 
                                       name="editSpecies" 
                                       value="${wood.name}"
                                       id="edit_${wood.name}"
                                       ${isSelected ? 'checked' : ''}
                                       onchange="updateEditSpeciesSelection(this)">
                                <label for="edit_${wood.name}">
                                    ${wood.name}
                                    <span class="price">${valorProduto}</span>
                                </label>
                            `;
                            especiesDiv.appendChild(div);
                        }
                    });
                } else {
                    especiesDiv.innerHTML = '<p>Nenhum produto dispon√≠vel no momento.</p>';
                }

                // Armazenar o ID do or√ßamento para refer√™ncia
                document.getElementById('editQuoteForm').dataset.orcamentoId = quoteId;

                showModal('editQuoteModal');
            }).catch(error => {
                console.error('Erro ao buscar or√ßamento para edi√ß√£o:', error);
                showStatus('Erro ao carregar or√ßamento para edi√ß√£o', true);
            });
        }

        function saveChanges(event) {
            event.preventDefault();
            const form = document.getElementById('editQuoteForm');
            const orcamentoId = form.dataset.orcamentoId;
            
            if (!orcamentoId) {
                showStatus('ID do or√ßamento n√£o encontrado', true);
                return;
            }
            
            // Obter as esp√©cies selecionadas com seus pre√ßos/quantidades
            const selectedSpecies = Array.from(document.querySelectorAll('#editQuoteForm input[name="editSpecies"]:checked'))
                .map(cb => {
                    const name = cb.value;
                    const quantidade = cb.parentElement.querySelector('.price').textContent;
                    return { nome: name, quantidade };
                });
            
            // Montar o objeto com os dados atualizados
            const orcamentoAtualizado = {
                nome: form.querySelector('#editNome').value,
                telefone: form.querySelector('#editTelefone').value,
                estado: form.querySelector('#editEstado').value,
                cidade: form.querySelector('#editCidade').value,
                // Manter compatibilidade com o formato antigo
                especies: selectedSpecies.map(p => `${p.nome} - ${p.quantidade}`),
                // Novo formato
                produtos: selectedSpecies,
                pedido: form.querySelector('#editPedido').value,
                observacoes: form.querySelector('#editObservacoes').value,
                contraProposta: form.querySelector('#editContraProposta').value,
                dataAtualizacao: new Date().toISOString(),
                status: 'atualizado'
            };
            
            // Atualizar no Firebase
            quotesRef.child(orcamentoId).update(orcamentoAtualizado)
                .then(() => {
                    showStatus('Or√ßamento atualizado com sucesso!');
                    closeModal('editQuoteModal');
                    loadQuotes(); // Recarregar a lista
                })
                .catch(error => {
                    console.error('Erro ao atualizar or√ßamento:', error);
                    showStatus('Erro ao atualizar or√ßamento: ' + error.message, true);
                });
        }

        function generateAndSendPDF(event) {
            event.preventDefault();
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configurar fonte e tamanho
                doc.setFontSize(12);
                
                // Adicionar logo da empresa
                const settings = JSON.parse(localStorage.getItem('companySettings') || '{}');
                if (settings.logo) {
                    doc.addImage(settings.logo, 'PNG', 10, 10, 30, 30);
                }
                
                // Informa√ß√µes da empresa (alinhadas √† direita da logo)
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(settings.name || 'JN MADEIRAS', 50, 20);
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(settings.address || 'TRAVESSA DOMINGOS MIRANDA CARNEIRO', 50, 30);
                doc.text(settings.phone || '(91) 9 9131-1049', 50, 40);
                doc.text(settings.email || 'jnmadeirasm@hotmail.com', 50, 50);
                
                // Linha separadora
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(10, 60, 200, 60);
                
                // T√≠tulo centralizado
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Or√ßamento', 105, 75, { align: 'center' });
                
                // Data do or√ßamento
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const data = new Date().toLocaleDateString('pt-BR');
                doc.text(`Data: ${data}`, 190, 75, { align: 'right' });
                
                // Linha separadora
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(10, 80, 200, 80);
                
                // Dados do cliente
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Dados do Cliente:', 20, 95);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Nome: ${document.getElementById('editNome').value}`, 20, 105);
                doc.text(`Telefone: ${document.getElementById('editTelefone').value}`, 20, 115);
                doc.text(`Estado: ${document.getElementById('editEstado').value}`, 20, 125);
                doc.text(`Cidade: ${document.getElementById('editCidade').value}`, 20, 135);
                
                // Detalhes do pedido
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Detalhes do Pedido:', 20, 155);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Pedido: ${document.getElementById('editPedido').value}`, 20, 165);
                
                // Esp√©cies selecionadas
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Esp√©cies Selecionadas:', 20, 185);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                let y = 195;
                const selectedSpecies = Array.from(document.querySelectorAll('#editQuoteForm input[name="editSpecies"]:checked'))
                    .map(cb => {
                        const price = cb.parentElement.querySelector('.price').textContent;
                        return `${cb.value} - ${price}`;
                    });
                selectedSpecies.forEach(species => {
                    doc.text(species, 20, y);
                    y += 10;
                });
                
                // Contra Proposta
                const contraProposta = document.getElementById('editContraProposta').value;
                if (contraProposta && contraProposta.trim() !== '') {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Contra Proposta:', 20, y + 10);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(contraProposta, 20, y + 20);
                    y += 30;
                }
                
                // Observa√ß√µes
                const observacoes = document.getElementById('editObservacoes').value;
                if (observacoes && observacoes.trim() !== '') {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Observa√ß√µes:', 20, y + 10);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(observacoes, 20, y + 20);
                }
                
                // Rodap√©
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(10, 280, 200, 280);
                doc.setFontSize(8);
                doc.text('Este or√ßamento tem validade de 30 dias a partir da data de emiss√£o.', 105, 290, { align: 'center' });
                
                // Salvar o PDF
                doc.save('orcamento.pdf');
                
                // Abrir WhatsApp com mensagem predefinida
                const message = encodeURIComponent(`Ol√° ${document.getElementById('editNome').value}! Segue o or√ßamento solicitado.`);
                window.open(`https://wa.me/${document.getElementById('editTelefone').value.replace(/\D/g, '')}?text=${message}`, '_blank');
                
                // Atualizar status do or√ßamento
                const orcamentoId = document.getElementById('editQuoteForm').dataset.orcamentoId;
                let orcamentos = JSON.parse(localStorage.getItem('orcamentos') || '[]');
                const index = orcamentos.findIndex(o => o.id === orcamentoId);
                
                if (index !== -1) {
                    orcamentos[index].status = 'Respondido';
                    localStorage.setItem('orcamentos', JSON.stringify(orcamentos));
                }
                
                // Fechar o modal
                closeModal('editQuoteModal');
                
                // Atualizar a lista de or√ßamentos
                loadQuotes();
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar o PDF. Por favor, tente novamente.');
            }
        }

        function updateNotificationCount() {
            const count = parseInt(localStorage.getItem('notificacoes') || '0');
            const countElement = document.getElementById('notificationCount');
            countElement.textContent = count;
            countElement.style.display = count > 0 ? 'block' : 'none';
        }

        function showChangePassword() {
            closeSidebar();
            const modal = document.getElementById('changePasswordModal');
            modal.style.display = 'block';
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.style.display = 'none';
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (currentPassword !== '20292029') {
                alert('Senha atual incorreta!');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('As senhas n√£o coincidem!');
                return;
            }

            if (newPassword.length < 8) {
                alert('A nova senha deve ter pelo menos 8 caracteres!');
                return;
            }

            // Aqui voc√™ pode implementar a l√≥gica para salvar a nova senha
            alert('Senha alterada com sucesso!');
            closeChangePasswordModal();
        }

        // Fun√ß√£o para tornar o modal arrast√°vel
        function makeDraggable(modalId) {
            const modal = document.getElementById(modalId);
            const modalContent = modal.querySelector('.modal-content');
            const modalHeader = modal.querySelector('.modal-header');
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            modalHeader.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === modalHeader || e.target.parentNode === modalHeader) {
                    isDragging = true;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, modalContent);
                }
            }

            function dragEnd() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }

            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
            }
        }

        // Verificar novos or√ßamentos
        function checkNewQuotes() {
            quotesRef.on('value', (snapshot) => {
                const quotes = snapshot.val() || {};
                const pendingQuotes = Object.values(quotes).filter(quote => quote.status === 'pendente');
                
                const notificationBadge = document.getElementById('notificationBadge');
                if (pendingQuotes.length > 0) {
                    notificationBadge.textContent = pendingQuotes.length;
                    notificationBadge.style.display = 'block';
                } else {
                    notificationBadge.style.display = 'none';
                }
            });
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            loadWoodData();
            loadPromoText();
            checkNewQuotes();
            updateNotificationCount();
            // Verificar novas notifica√ß√µes a cada minuto
            setInterval(updateNotificationCount, 60000);
        });

        function openEditModal(orcamento) {
            const modal = document.getElementById('editQuoteModal');
            const form = document.getElementById('editQuoteForm');
            
            // Preencher o formul√°rio com os dados do or√ßamento
            form.querySelector('#editNome').value = orcamento.nome;
            form.querySelector('#editTelefone').value = orcamento.telefone;
            form.querySelector('#editEstado').value = orcamento.estado;
            form.querySelector('#editCidade').value = orcamento.cidade;
            form.querySelector('#editPedido').value = orcamento.pedido;
            form.querySelector('#editObservacoes').value = orcamento.observacoes || '';
            form.querySelector('#editContraProposta').value = orcamento.contraProposta || '';
            
            // Preencher as esp√©cies selecionadas
            const speciesGrid = form.querySelector('#editEspecies');
            speciesGrid.innerHTML = '';
            
            // Criar um mapa de esp√©cies selecionadas para f√°cil acesso
            const selectedSpeciesMap = new Map(
                orcamento.especies.map(species => {
                    const [name, price] = species.split(' - ');
                    return [name, price];
                })
            );
            
            // Usar woodData do Firebase (vari√°vel global j√° carregada)
            // em vez de buscar do localStorage
            if (woodData && woodData.length > 0) {
                // Ordenar as esp√©cies por nome para melhor usabilidade
                const sortedWoodData = [...woodData].sort((a, b) => 
                    a.name.localeCompare(b.name, 'pt-BR')
                );
                
                sortedWoodData.forEach(wood => {
                    if (wood.visible) {
                        const div = document.createElement('div');
                        div.className = 'species-item';
                        
                        // Verificar se esta esp√©cie est√° selecionada
                        const isSelected = selectedSpeciesMap.has(wood.name);
                        const price = isSelected ? selectedSpeciesMap.get(wood.name) : formatCurrency(wood.price);
                        
                        div.innerHTML = `
                            <input type="checkbox" 
                                   name="editSpecies" 
                                   value="${wood.name}"
                                   id="edit_${wood.name}"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="updateEditSpeciesSelection(this)">
                            <label for="edit_${wood.name}">
                                ${wood.name}
                                <span class="price">${price}</span>
                            </label>
                        `;
                        speciesGrid.appendChild(div);
                    }
                });
            } else {
                console.error('Erro: woodData n√£o est√° dispon√≠vel');
                speciesGrid.innerHTML = '<p>Erro ao carregar esp√©cies. Tente novamente mais tarde.</p>';
            }
            
            // Armazenar o ID do or√ßamento para refer√™ncia
            form.dataset.orcamentoId = orcamento.id;
            
            modal.style.display = 'block';
        }

        function updateEditSpeciesSelection(checkbox) {
            const selectedSpecies = Array.from(document.querySelectorAll('#editQuoteForm input[name="editSpecies"]:checked'))
                .map(cb => {
                    const price = cb.parentElement.querySelector('.price').textContent;
                    return `${cb.value} - ${price}`;
                });
            
            // Atualizar o campo de esp√©cies selecionadas
            document.getElementById('editSelectedSpecies').value = selectedSpecies.join('\n');
        }
    </script>
</body>
</html> 